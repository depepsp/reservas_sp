<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Servidor – Sala de Pesquisadores (BC/SP)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
  :root { --maxw: 1100px; }
  body { font-family: Arial, sans-serif; margin:0; background:#fff; }
  header { padding:12px 16px; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .wrap { max-width: var(--maxw); margin: 0 auto; padding: 8px 16px; }
  .box { border:1px solid #ddd; padding:10px; border-radius:8px; background:#fafafa; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
  label { display:flex; flex-direction:column; font-size:13px; min-width: 180px; }
  input, button { padding:8px; }
  button { cursor:pointer; }
  #calendar { max-width: var(--maxw); margin: 12px auto; }
  .hint { font-size:12px; color:#666; }
  .ok { color:#0a7a0a; }
  .err { color:#b00020; }
</style>
</head>
<body>
<header class="wrap">
  <strong>Servidor – Calendário da Sala (09:00–19:00)</strong>
  <span class="hint">Crie eventos para servidores (regras de horário e dia útil ativas).</span>
</header>

<section class="wrap">
  <div class="box" style="margin-bottom:12px;">
    <div class="row">
      <label>Seu nome
        <input id="nome" placeholder="Ex.: Maria Silva">
      </label>
      <label>Data
        <input id="date" type="date">
      </label>
      <label>Início
        <input id="start" type="time" value="09:00" step="1800">
      </label>
      <label>Fim
        <input id="end" type="time" value="10:00" step="1800">
      </label>
      <button id="btnCreate">Criar (Servidor)</button>
    </div>
    <div id="msg" class="hint" style="margin-top:6px;"></div>
  </div>
</section>

<div id="calendar" class="wrap"></div>

<script>
/* Cole aqui o URL /exec da sua implantação */
const WEB_APP_URL = "https://script.google.com/macros/s/SEU_DEPLOY_ID/exec";

/* ===== helpers de chamada (sem preflight) ===== */
async function apiGet(params){
  const url = WEB_APP_URL + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url, { method:"GET" });
  if (!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}
async function apiPost(obj){
  const r = await fetch(WEB_APP_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=UTF-8" }, // simples
    body: JSON.stringify(obj)
  });
  const j = await r.json().catch(()=>({status:"erro",mensagem:"Falha JSON"}));
  if (!r.ok || j.status==="erro") throw new Error(j.mensagem || ("HTTP "+r.status));
  return j;
}

const $ = (id)=>document.getElementById(id);
const msg = $("msg");

/* ===== criação via formulário ===== */
$("btnCreate").onclick = async ()=>{
  msg.className = "hint";
  msg.textContent = "";
  const nome  = $("nome").value.trim();
  const date  = $("date").value;
  const start = $("start").value;
  const end   = $("end").value;
  if (!nome||!date||!start||!end){
    msg.className = "hint err";
    msg.textContent = "Preencha nome, data, início e fim.";
    return;
  }
  try{
    await apiPost({
      action: "create",
      tipo:   "Servidor",      // o backend normaliza para "Servidor do Depep"
      nome, date, start, end
    });
    msg.className = "hint ok";
    msg.textContent = "Reserva criada com sucesso.";
    calendar.refetchEvents();
  }catch(e){
    msg.className = "hint err";
    msg.textContent = e.message;
  }
};

/* ===== FullCalendar ===== */
let calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView: 'timeGridWeek',
  slotMinTime: "09:00:00",
  slotMaxTime: "19:00:00",
  slotDuration: "00:30:00",     // intervalos de 30 min
  allDaySlot: false,
  locale: 'pt-br',
  height: 'auto',
  nowIndicator: true,
  expandRows: true,
  firstDay: 1,
  selectable: true,
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'timeGridWeek,timeGridDay,dayGridMonth'
  },
  events: async (info, success, failure)=>{
    try{
      // FullCalendar envia ISO; backend espera yyyy-MM-dd
      const s = info.startStr.substring(0,10);
      const e = info.endStr.substring(0,10);
      const data = await apiGet({action:"list", start:s, end:e});
      success(data.events || []);
    }catch(err){ failure(err); }
  },
  select: async (sel)=>{
    // criar arrastando/selecionando no grid
    const nome = $("nome").value.trim();
    if (!nome){
      alert("Informe seu nome (campo acima) antes de criar.");
      calendar.unselect();
      return;
    }
    const ymd = sel.startStr.substring(0,10);
    const hs  = sel.startStr.substring(11,16);
    const he  = sel.endStr.substring(11,16);
    try{
      await apiPost({ action:"create", tipo:"Servidor", nome, date: ymd, start: hs, end: he });
      calendar.refetchEvents();
    }catch(e){ alert(e.message); }
  },
  eventClick: async (info)=>{
    // por enquanto só informativo; rotas de delete/confirm não estão ativas
    const ev = info.event;
    alert(`${ev.title}\n${ev.start.toLocaleString()} — ${ev.end.toLocaleString()}`);
  }
});
calendar.render();
</script>
</body>
</html>
