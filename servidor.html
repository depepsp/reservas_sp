<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Servidor – Sala de Pesquisadores (BC/SP)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
  :root { --maxw: 1100px; }
  body { font-family: Arial, sans-serif; margin:0; background:#fff; color:#111; }
  header { padding:12px 16px; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .wrap { max-width: var(--maxw); margin: 0 auto; padding: 8px 16px; }
  #calendar { max-width: var(--maxw); margin: 12px auto; }

  /* Overlay carregando */
  #loadingOverlay {
    display:none; position:fixed; inset:0; background:rgba(255,255,255,0.8);
    z-index:9999; align-items:center; justify-content:center; font-size:20px; font-weight:600;
  }

  /* Modal simples */
  #evtModal { position: fixed; inset: 0; display:none; z-index: 9999; }
  #evtModal.active { display:flex; align-items:center; justify-content:center; }
  #evtModal .panel {
    width:min(92vw, 480px); background:#fff; border-radius:10px;
    box-shadow:0 12px 28px rgba(0,0,0,.2); overflow:hidden;
  }
  .panel-hd { padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
  .panel-tt { margin:0; font-weight:700; font-size:16px; }
  .panel-bd { padding:14px 16px; font-size:14px; display:flex; flex-direction:column; gap:8px; }
  .panel-ft { padding:12px 16px; border-top:1px solid #eee; text-align:right; }
  .btn { padding:8px 12px; border:1px solid #ddd; background:#f7f7f7; border-radius:6px; cursor:pointer; }
  .btn.primary { background:#f0f6ff; border-color:#c6dafc; }
</style>
</head>
<body>
<header class="wrap">
  <strong>Servidor do Depep</strong> – informe sua disponibilidade para receber pesquisadores externos no BC.<br>
  <span class="hint">Regras: agendamentos apenas de hoje até 60 dias à frente, em dias úteis, entre 09:00 e 19:00, com intervalos de 30 minutos.</span>
</header>

<div id="calendar" class="wrap"></div>

<!-- Overlay de carregamento -->
<div id="loadingOverlay">Carregando...</div>

<!-- Modal de confirmação -->
<div id="evtModal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panel-hd">
      <h3 class="panel-tt">Confirmar agendamento</h3>
      <button class="btn" onclick="closeEvt()">Fechar</button>
    </div>
    <div class="panel-bd">
      <label>Nome do servidor:
        <input id="nomeServidor" placeholder="Digite seu nome">
      </label>
      <div id="resumoReserva"></div>
      <label><input type="checkbox" id="recorrente"> Repetir semanalmente</label>
    </div>
    <div class="panel-ft">
      <button class="btn" onclick="closeEvt()">Cancelar</button>
      <button class="btn primary" id="btnConfirmar">Confirmar</button>
    </div>
  </div>
</div>

<script>
/* ======= CONFIG ======= */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxjozQ0uqsL1brvYl9o3C5qmQRLvBSj-5OANkCabVuNQdWzzqV2gXWOHp6ZMA1ekFeD/exec"; // <-- substitua
const HORIZON_DAYS = 60;

/* ======= HELPERS ======= */
function showLoading(on){
  document.getElementById('loadingOverlay').style.display = on ? 'flex':'none';
}
async function apiGet(params){
  const qs = new URLSearchParams(params).toString();
  const r = await fetch(`${WEB_APP_URL}?${qs}`);
  return await r.json();
}
async function apiPost(obj){
  const r = await fetch(WEB_APP_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=UTF-8"},
    body: JSON.stringify(obj)
  });
  return await r.json();
}

/* ======= Modal helpers ======= */
let pendingSel = null;
function openEvt(sel){
  pendingSel = sel;
  const d = new Date(sel.start);
  const de= new Date(sel.end);
  const pad=n=>String(n).padStart(2,"0");
  const resumo = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}–${pad(de.getHours())}:${pad(de.getMinutes())}`;
  document.getElementById("resumoReserva").textContent = resumo;
  document.getElementById("evtModal").classList.add("active");
}
function closeEvt(){
  document.getElementById("evtModal").classList.remove("active");
  pendingSel=null;
}

/* ======= Calendário ======= */
let calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView:'timeGridWeek',
  locale:'pt-br',
  height:'auto',
  nowIndicator:true,
  expandRows:true,
  firstDay:1,
  allDaySlot:false,
  slotMinTime:"09:00:00",
  slotMaxTime:"19:00:00",
  slotDuration:"00:30:00",
  snapDuration:"00:30:00",
  selectable:true,
  selectMirror:true,
  validRange:{
    start: new Date().toISOString().split("T")[0],
    end: new Date(Date.now()+HORIZON_DAYS*86400000).toISOString().split("T")[0]
  },
  businessHours:{
    daysOfWeek:[1,2,3,4,5],
    startTime:"09:00",
    endTime:"19:00"
  },
  headerToolbar:{
    left:'prev,next today',
    center:'title',
    right:'timeGridWeek,timeGridDay,dayGridMonth'
  },
  events: async (info, success, failure)=>{
    try{
      showLoading(true);
      const data = await apiGet({
        action:"list",
        start: info.startStr.substring(0,10),
        end:   info.endStr.substring(0,10)
      });
      success(Array.isArray(data.events)?data.events:[]);
    }catch(err){failure(err);}finally{showLoading(false);}
  },
  select: (sel)=>{ openEvt(sel); }
});
calendar.render();

/* ======= Confirmar agendamento ======= */
document.getElementById("btnConfirmar").onclick = async ()=>{
  const nome = document.getElementById("nomeServidor").value.trim();
  const rec  = document.getElementById("recorrente").checked;
  if (!nome){alert("Informe seu nome.");return;}
  if (!pendingSel){closeEvt();return;}

  const d=pendingSel.start, de=pendingSel.end;
  const date = d.toISOString().substring(0,10);
  const start= d.toTimeString().substring(0,5);
  const end  = de.toTimeString().substring(0,5);

  try{
    showLoading(true);
    const r = await apiPost({
      action:"create",
      tipo:"Servidor do Depep",
      nome, date, start, end,
      recorrente: rec
    });
    alert("Reserva criada. Token: "+r.token);
    calendar.refetchEvents();
  }catch(e){alert("Falha ao criar: "+e.message);}
  finally{showLoading(false);closeEvt();}
};
</script>
</body>
</html>
