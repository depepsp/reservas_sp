<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Reserva da Sala de Pesquisadores - Depep/SP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- flatpickr para o campo de DATA -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root { --maxw: 640px; }
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
    }
    .wrap {
      width: 100%;
      max-width: var(--maxw);
      padding: 24px;
      box-sizing: border-box;
      text-align: center;
    }
    h2 { margin: 0 0 16px 0; }

    form {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    label {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 360px;
      text-align: left;
      position: relative; /* calendário fica logo abaixo */
    }
    input, select, button {
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
      width: 100%;
    }
    button { width: auto; padding: 10px 20px; cursor: pointer; }
    .error { color: red; margin-top: 6px; min-height: 1.2em; }

    .flatpickr-calendar { z-index: 9999 !important; }

    /* Loader do FORM */
    #loading {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.75);
      display: none;
      align-items: center; justify-content: center;
      font-weight: 600; z-index: 1000000; pointer-events: all;
      backdrop-filter: blur(1px);
    }
    .spinner {
      width: 28px; height: 28px; border: 3px solid #ccc;
      border-top-color: #555; border-radius: 50%;
      animation: spin 0.9s linear infinite; margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading .wrap-loading { display: flex; align-items: center; font-size: 16px; color: #333; }

    .calendar-link { margin-top: 12px; font-size: 14px; }
    .calendar-link a { text-decoration: underline; cursor: pointer; }

    /* ===== Modal da AGENDA ===== */
    #agendaModal { position: fixed; inset: 0; display: none; z-index: 2000000; }
    #agendaModal.active { display: block; }
    #agendaModal .backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.35); }
    #agendaModal .panel {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(92vw, 760px); max-height: 85vh;
      background: #fff; border-radius: 10px; box-shadow: 0 12px 28px rgba(0,0,0,.2);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-header {
      padding: 12px 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .panel-title { margin: 0; font-size: 18px; font-weight: 700; }
    .panel-actions { display: flex; gap: 8px; }
    .panel-actions button {
      padding: 8px 12px; border: 1px solid #ddd; background: #f7f7f7; border-radius: 6px; cursor: pointer;
    }
    .panel-close {
      border: none; background: transparent; font-size: 22px; line-height: 1; cursor: pointer; margin-left: 4px;
    }
    .panel-body { padding: 12px 16px; overflow: auto; }
    .modal-loading { display: flex; align-items: center; justify-content: center; color: #333; font-weight: 600; height: 240px; }
    .modal-loading .spinner { margin-right: 10px; }

    .dia { margin-top: 16px; }
    .dia-titulo { font-weight: 700; margin-bottom: 6px; }
    .ev { border: 1px solid #ddd; border-left: 6px solid; padding: 6px 8px; margin: 6px 0; border-radius: 6px; background: #fafafa; }
    .ev .hora { font-weight: 600; margin-right: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Reserva da Sala de Pesquisadores do Depep-SP</h2>

    <!-- Loader do FORM -->
    <div id="loading" aria-live="polite" aria-busy="true">
      <div class="wrap-loading"><div class="spinner"></div>Carregando…</div>
    </div>

    <form id="reservaForm" autocomplete="off">
      <label>Você é:
        <select name="tipo" required id="tipoSelect">
          <option value="">Selecione...</option>
          <option value="Pesquisador externo ou Estagiário do BC">Pesquisador externo ou Estagiário do BC</option>
          <option value="Servidor do Depep">Servidor do Depep</option>
        </select>
      </label>

      <label id="dataLabel">Data da reserva:
        <input type="text" name="data" required id="dataInput" placeholder="Selecione a data" disabled>
      </label>

      <label>Hora de início (a partir das 09:00):
        <select name="inicio" required id="inicioSelect"></select>
      </label>

      <label>Hora de término (até as 18:00):
        <select name="fim" required id="fimSelect"></select>
      </label>

      <label>Nome completo:
        <input type="text" name="nome" required>
      </label>

      <div class="error" id="erroMsg"></div>
      <button type="submit" id="btnEnviar">Reservar</button>

      <div class="calendar-link">
        Para consultar o calendário da Sala de Pesquisadores,
        <a href="#agenda" onclick="initAgenda(event)">clique aqui</a>.
      </div>
    </form>
  </div>

  <!-- ===== Modal da AGENDA ===== -->
  <div id="agendaModal" aria-hidden="true">
    <div class="backdrop" onclick="closeAgenda()"></div>
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="agendaTitle">
      <div class="panel-header">
        <div class="panel-title" id="agendaTitle">Agenda pública – próximos 60 dias</div>
        <div class="panel-actions">
          <button type="button" id="btnRefreshAgenda" title="Recarregar a agenda">Atualizar</button>
          <button type="button" onclick="closeAgenda()">Voltar ao formulário</button>
          <button class="panel-close" type="button" aria-label="Fechar" onclick="closeAgenda()">×</button>
        </div>
      </div>
      <div id="agendaBody" class="panel-body">
        <div class="modal-loading"><div class="spinner"></div>Carregando…</div>
      </div>
    </div>
  </div>

  <script>
    /* CONFIG: URLs do seu Web App (terminam com /exec) */
    const WEB_APP_URL    = "https://script.google.com/macros/s/AKfycbyx4AvyTzL4zPZ02WKXyX-AFFjDq76yCVb-96v83Du2LnW0X-TaoR-eN1C_3jCDKco/exec"; // formulário
    const AGENDA_API_URL = "https://script.google.com/macros/s/AKfycbyx4AvyTzL4zPZ02WKXyX-AFFjDq76yCVb-96v83Du2LnW0X-TaoR-eN1C_3jCDKco/exec"; // agenda JSON (pode ser o mesmo)

    const form      = document.getElementById("reservaForm");
    const erroDiv   = document.getElementById("erroMsg");
    const dataInput = document.getElementById("dataInput");
    const dataLabel = document.getElementById("dataLabel");
    const tipoSel   = document.getElementById("tipoSelect");
    const inicioSel = document.getElementById("inicioSelect");
    const fimSel    = document.getElementById("fimSelect");
    const btnEnviar = document.getElementById("btnEnviar");
    const loading   = document.getElementById("loading");

    // Parâmetros alinhados com o backend
    const HORIZON_DAYS = 60;
    const OPEN_TIME = "09:00";
    const CLOSE_TIME = "18:00";

    let diasLotados = [];

    // Loader do FORM
    function setLoading(on) {
      loading.style.display = on ? "flex" : "none";
      document.body.style.cursor = on ? "progress" : "default";
      btnEnviar.disabled = !!on;
    }

    // Horários (09:00..18:00)
    function populateTimeSelect(selectEl, startHour = 9, endHour = 18) {
      selectEl.innerHTML = "";
      const first = document.createElement("option");
      first.value = ""; first.textContent = "Selecione...";
      selectEl.appendChild(first);
      for (let h = startHour; h <= endHour; h++) {
        const hh = String(h).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = `${hh}:00`;
        opt.textContent = `${hh}:00`;
        selectEl.appendChild(opt);
      }
    }
    populateTimeSelect(inicioSel);
    populateTimeSelect(fimSel);

    // Datas: hoje até +60 dias
    const today = new Date(); today.setHours(0,0,0,0);
    const maxDate = new Date(today.getTime() + HORIZON_DAYS*24*60*60*1000);

    function disableFn(date) {
      if (date.getDay() === 0 || date.getDay() === 6) return true; // fds
      if (date < today) return true;                                // passado
      if (date > maxDate) return true;                              // >60 dias
      if (!tipoSel.value) return true;                              // sem tipo
      const d = flatpickr.formatDate(date, "Y-m-d");
      return diasLotados.includes(d);
    }

    let fpDate = flatpickr("#dataInput", {
      dateFormat: "Y-m-d",
      disable: [ disableFn ],
      static: true,
      appendTo: dataLabel,
      positionElement: dataInput,
      minDate: today,
      maxDate: maxDate
    });

    // Backend (sem preflight)
    async function fetchDiasLotados(tipo) {
      const url = `${WEB_APP_URL}?action=diasLotados&tipo=${encodeURIComponent(tipo)}&t=${Date.now()}`;
      const r = await fetch(url, { method: "GET" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function enviarReserva(payload) {
      const r = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify({ action: "reservar", ...payload })
      });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function atualizarDiasLotados() {
      const tipo = tipoSel.value;
      if (!tipo) {
        dataInput.disabled = true;
        diasLotados = [];
        fpDate.set("disable", [ disableFn ]);
        fpDate.redraw();
        return;
      }
      dataInput.disabled = false;
      setLoading(true);
      try {
        const datas = await fetchDiasLotados(tipo);
        diasLotados = Array.isArray(datas) ? datas : [];
        fpDate.set("disable", [ disableFn ]);
        fpDate.redraw();
        if (dataInput.value && diasLotados.includes(dataInput.value)) {
          fpDate.clear();
        }
      } catch (err) {
        erroDiv.textContent = "Erro ao carregar disponibilidade: " + err.message;
      } finally {
        setLoading(false);
      }
    }

    tipoSel.addEventListener("change", atualizarDiasLotados);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      erroDiv.style.color = "red";
      erroDiv.textContent = "";
      if (!inicioSel.value || !fimSel.value) {
        erroDiv.textContent = "Selecione as horas de início e término.";
        return;
      }
      const dados = Object.fromEntries(new FormData(form));
      setLoading(true);
      try {
        const resp = await enviarReserva(dados);
        if (resp.status === "erro") {
          erroDiv.textContent = resp.mensagem || "Erro ao reservar.";
        } else {
          erroDiv.style.color = "green";
          erroDiv.textContent = "Reserva registrada com sucesso.";
          form.reset();
          dataInput.disabled = true;
          await atualizarDiasLotados();
        }
      } catch (err) {
        erroDiv.textContent = "Erro interno: " + err.message;
      } finally {
        setLoading(false);
      }
    });

    /************** AGENDA (JSON -> MODAL) **************/
    const agendaModal = document.getElementById('agendaModal');
    const agendaBody  = document.getElementById('agendaBody');
    const btnRefresh  = document.getElementById('btnRefreshAgenda');

    function openAgenda() {
      agendaModal.classList.add('active');
      agendaBody.innerHTML = '<div class="modal-loading"><div class="spinner"></div>Carregando…</div>';
      document.addEventListener('keydown', escClose);
    }
    function closeAgenda() {
      agendaModal.classList.remove('active');
      document.removeEventListener('keydown', escClose);
    }
    function escClose(e){ if (e.key === 'Escape') closeAgenda(); }

    async function carregarAgenda() {
      agendaBody.innerHTML = '<div class="modal-loading"><div class="spinner"></div>Carregando…</div>';
      try {
        const url = `${AGENDA_API_URL}?action=agendaJson&t=${Date.now()}`;
        const resp = await fetch(url, { method: 'GET' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        if (!data.days || data.days.length === 0) {
          agendaBody.textContent = "Sem eventos nos próximos 60 dias.";
          return;
        }

        const frag = document.createDocumentFragment();
        data.days.forEach(d => {
          const dia = document.createElement('div');
          dia.className = 'dia';

          const titulo = document.createElement('div');
          titulo.className = 'dia-titulo';
          const [Y,M,D] = d.date.split('-');
          titulo.textContent = `${D}/${M}/${Y}`;
          dia.appendChild(titulo);

          d.events.forEach(ev => {
            const box = document.createElement('div');
            box.className = 'ev';
            box.style.borderLeftColor = ev.color;

            const hora = document.createElement('span');
            hora.className = 'hora';
            hora.textContent = `${ev.start}–${ev.end} `;
            box.appendChild(hora);

            const sum = document.createElement('span');
            sum.textContent = ev.summary;
            box.appendChild(sum);

            dia.appendChild(box);
          });

          frag.appendChild(dia);
        });

        agendaBody.innerHTML = '';
        agendaBody.appendChild(frag);

      } catch (err) {
        agendaBody.textContent = "Erro ao carregar a agenda: " + err.message;
      }
    }

    function initAgenda(e) {
      if (e) e.preventDefault();
      openAgenda();
      carregarAgenda(); // carrega ao abrir
    }
    btnRefresh.addEventListener('click', carregarAgenda);

    window.initAgenda = initAgenda;
    window.closeAgenda = closeAgenda;
  </script>
</body>
</html>
