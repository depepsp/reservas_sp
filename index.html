<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Reserva da Sala de Pesquisadores - Depep/SP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- flatpickr para o campo de DATA -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root { --maxw: 640px; }
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
    }
    .wrap {
      width: 100%;
      max-width: var(--maxw);
      padding: 24px;
      box-sizing: border-box;
      text-align: center;
    }
    h2 { margin: 0 0 16px 0; }

    form {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    label {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 360px;
      text-align: left;
      position: relative; /* calendário fica logo abaixo */
    }
    input, select, button {
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
      width: 100%;
    }
    button { width: auto; padding: 10px 20px; cursor: pointer; }
    .error { color: red; margin-top: 6px; min-height: 1.2em; }

    /* flatpickr acima de tudo */
    .flatpickr-calendar { z-index: 9999 !important; }

    /* Loader do FORM */
    #loading {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.75);
      display: none;
      align-items: center; justify-content: center;
      font-weight: 600; z-index: 1000000; pointer-events: all;
      backdrop-filter: blur(1px);
    }
    .spinner {
      width: 28px; height: 28px; border: 3px solid #ccc;
      border-top-color: #555; border-radius: 50%;
      animation: spin 0.9s linear infinite; margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading .wrap-loading { display: flex; align-items: center; font-size: 16px; color: #333; }

    .calendar-link { margin-top: 12px; font-size: 14px; }
    .calendar-link a { text-decoration: underline; cursor: pointer; }

    /* ===== Modal da AGENDA ===== */
    #agendaModal { position: fixed; inset: 0; display: none; z-index: 2000000; }
    #agendaModal.active { display: block; }
    #agendaModal .backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.35); }
#agendaModal .panel {
  position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
  /* antes: width: min(92vw, 760px); max-height: 85vh; */
  width: min(96vw, 980px);
  max-height: 92vh;

  background: #fff; border-radius: 10px; box-shadow: 0 12px 28px rgba(0,0,0,.2);
  display: flex; flex-direction: column; overflow: hidden;
}
/* Tipografia mais compacta no modal */
#agendaModal { font-size: 14px; }              /* base menor dentro do modal */
.panel-title { font-size: 16px; }               /* antes era 18px */
.col-header  { font-size: 14px; }               /* cabeçalho das colunas */
.dia-titulo  { font-size: 13px; }               /* data do dia */
.ev          { font-size: 13px; line-height: 1.25; }
.ev .hora    { font-weight: 600; margin-right: 6px; }
    .panel-header {
      padding: 12px 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .panel-title { margin: 0; font-size: 18px; font-weight: 700; }
    .panel-actions { display: flex; gap: 8px; }
    .panel-actions button {
      padding: 8px 12px; border: 1px solid #ddd; background: #f7f7f7; border-radius: 6px; cursor: pointer;
    }
    .panel-close {
      border: none; background: transparent; font-size: 22px; line-height: 1; cursor: pointer; margin-left: 4px;
    }
    .panel-body { padding: 10px 12px; overflow: auto; }
    .modal-loading { display: flex; align-items: center; justify-content: center; color: #333; font-weight: 600; height: 240px; }
    .modal-loading .spinner { margin-right: 10px; }

    /* ===== Agenda em duas colunas ===== */
    .cols {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 800px) {
      .cols { grid-template-columns: 1fr 1fr; }
    }
    .col {
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }
    .col-header {
      padding: 10px 12px;
      font-weight: 700;
      background: #f7f7f7;
      border-bottom: 1px solid #eee;
    }
    .col-body { padding: 8px 10px; }
    .dia { margin-top: 14px; }
    .dia-titulo { font-weight: 700; margin-bottom: 6px; }
    .ev {
      border: 1px solid #ddd;
      border-left: 6px solid;
      padding: 5px 8px;
      margin: 6px 0;
      border-radius: 6px;
      background: #fafafa;
    }
    .ev .hora { font-weight: 600; margin-right: 6px; }
    .col-empty { color: #666; font-style: italic; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Reserva da Sala de Pesquisadores do Depep-SP</h2>

    <!-- Loader do FORM -->
    <div id="loading" aria-live="polite" aria-busy="true">
      <div class="wrap-loading"><div class="spinner"></div>Carregando…</div>
    </div>

    <form id="reservaForm" autocomplete="off">
      <label>Você é:
        <select name="tipo" required id="tipoSelect">
          <option value="">Selecione...</option>
          <option value="Pesquisador externo ou Estagiário do BC">Pesquisador externo ou Estagiário do BC</option>
          <option value="Servidor do Depep">Servidor do Depep</option>
        </select>
      </label>

      <label id="dataLabel">Data da reserva:
        <input type="text" name="data" required id="dataInput" placeholder="Selecione a data" disabled>
      </label>

      <label>Hora de início (a partir das 09:00):
        <select name="inicio" required id="inicioSelect"></select>
      </label>

      <label>Hora de término (até as 19:00):
        <select name="fim" required id="fimSelect"></select>
      </label>

      <label>Nome completo:
        <input type="text" name="nome" required>
      </label>

      <div class="error" id="erroMsg"></div>
      <button type="submit" id="btnEnviar">Reservar</button>

      <div class="calendar-link">
        Para consultar o calendário da Sala de Pesquisadores,
        <a href="#agenda" onclick="initAgenda(event)">clique aqui</a>.
      </div>
    </form>
  </div>

  <!-- ===== Modal da AGENDA ===== -->
  <div id="agendaModal" aria-hidden="true">
    <div class="backdrop" onclick="closeAgenda()"></div>
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="agendaTitle">
      <div class="panel-header">
        <div class="panel-title" id="agendaTitle">Agenda da Sala de Pesquisadores – próximos 60 dias</div>
        <div class="panel-actions">
          <button type="button" id="btnRefreshAgenda" title="Recarregar a agenda">Atualizar</button>
          <button class="panel-close" type="button" aria-label="Fechar" onclick="closeAgenda()">×</button>
        </div>
      </div>
      <div id="agendaBody" class="panel-body">
        <div class="modal-loading"><div class="spinner"></div>Carregando…</div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    /***** CONFIG: COLE AQUI O URL DO SEU WEB APP (termina com /exec) *****/
    const WEB_APP_URL    = "https://script.google.com/macros/s/AKfycbzwnEmk_SmDeblGVneOjzd-J5Fd08DD2Z6gsW5KrHMpTb8sb_OtHVA91jN5v2OctOYj/exec";
    const AGENDA_API_URL = WEB_APP_URL; // pode ser o mesmo

    const form      = document.getElementById("reservaForm");
    const erroDiv   = document.getElementById("erroMsg");
    const dataInput = document.getElementById("dataInput");
    const dataLabel = document.getElementById("dataLabel");
    const tipoSel   = document.getElementById("tipoSelect");
    const inicioSel = document.getElementById("inicioSelect");
    const fimSel    = document.getElementById("fimSelect");
    const btnEnviar = document.getElementById("btnEnviar");
    const loading   = document.getElementById("loading");

    // Janela de funcionamento e horizonte
    const HORIZON_DAYS = 60;
    const OPEN_TIME  = "09:00";
    const CLOSE_TIME = "19:00";

    let diasLotados = [];

    // Loader do FORM
    function setLoading(on) {
      loading.style.display = on ? "flex" : "none";
      document.body.style.cursor = on ? "progress" : "default";
      btnEnviar.disabled = !!on;
    }

    // Gera opções de 30 em 30 min entre 09:00 e 19:00
    function populateTimeSelect30(selectEl, startHour = 9, endHour = 19) {
      selectEl.innerHTML = "";
      const first = document.createElement("option");
      first.value = ""; first.textContent = "Selecione...";
      selectEl.appendChild(first);

      for (let h = startHour; h <= endHour; h++) {
        for (let m of [0, 30]) {
          const hh = String(h).padStart(2, "0");
          const mm = String(m).padStart(2, "0");
          const val = `${hh}:${mm}`;
          // não permitir 19:30 etc.
          if (h === endHour && m > 0) continue;
          const opt = document.createElement("option");
          opt.value = val; opt.textContent = val;
          selectEl.appendChild(opt);
        }
      }
    }
    populateTimeSelect30(inicioSel, 9, 19);
    populateTimeSelect30(fimSel,    9, 19);

    // Datas: hoje até +60 dias
    const today   = new Date(); today.setHours(0,0,0,0);
    const maxDate = new Date(today.getTime() + HORIZON_DAYS*24*60*60*1000);

    function disableFn(date) {
      if (date.getDay() === 0 || date.getDay() === 6) return true; // fds
      if (date < today) return true;                                // passado
      if (date > maxDate) return true;                              // >60 dias
      if (!tipoSel.value) return true;                              // sem tipo
      const d = flatpickr.formatDate(date, "Y-m-d");
      return diasLotados.includes(d);
    }

    let fpDate = flatpickr("#dataInput", {
      dateFormat: "Y-m-d",
      disable: [ disableFn ],
      static: true,
      appendTo: dataLabel,
      positionElement: dataInput,
      minDate: today,
      maxDate: maxDate
    });

    // Backend (sem preflight)
    async function fetchDiasLotados(tipo) {
      const url = `${WEB_APP_URL}?action=diasLotados&tipo=${encodeURIComponent(tipo)}&t=${Date.now()}`;
      const r = await fetch(url, { method: "GET" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function enviarReserva(payload) {
      const r = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify({ action: "reservar", ...payload })
      });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function atualizarDiasLotados() {
      const tipo = tipoSel.value;
      if (!tipo) {
        dataInput.disabled = true;
        diasLotados = [];
        fpDate.set("disable", [ disableFn ]);
        fpDate.redraw();
        return;
      }
      dataInput.disabled = false;
      setLoading(true);
      try {
        const datas = await fetchDiasLotados(tipo);
        diasLotados = Array.isArray(datas) ? datas : [];
        fpDate.set("disable", [ disableFn ]);
        fpDate.redraw();
        if (dataInput.value && diasLotados.includes(dataInput.value)) {
          fpDate.clear();
        }
      } catch (err) {
        erroDiv.textContent = "Erro ao carregar disponibilidade: " + err.message;
      } finally {
        setLoading(false);
      }
    }

    tipoSel.addEventListener("change", atualizarDiasLotados);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      erroDiv.style.color = "red";
      erroDiv.textContent = "";
      if (!inicioSel.value || !fimSel.value) {
        erroDiv.textContent = "Selecione as horas de início e término.";
        return;
      }
      const dados = Object.fromEntries(new FormData(form));
      setLoading(true);
      try {
        const resp = await enviarReserva(dados);
        if (resp.status === "erro") {
          erroDiv.textContent = resp.mensagem || "Erro ao reservar.";
        } else {
          erroDiv.style.color = "green";
          erroDiv.textContent = "Reserva registrada com sucesso.";
          form.reset();
          dataInput.disabled = true;
          await atualizarDiasLotados();
        }
      } catch (err) {
        erroDiv.textContent = "Erro interno: " + err.message;
      } finally {
        setLoading(false);
      }
    });

    /************** AGENDA (JSON -> MODAL) **************/
    const agendaModal = document.getElementById('agendaModal');
    const agendaBody  = document.getElementById('agendaBody');
    const btnRefresh  = document.getElementById('btnRefreshAgenda');

    function openAgenda() {
      agendaModal.classList.add('active');
      agendaBody.innerHTML = '<div class="modal-loading"><div class="spinner"></div>Carregando…</div>';
      document.addEventListener('keydown', escClose);
    }
    function closeAgenda() {
      agendaModal.classList.remove('active');
      document.removeEventListener('keydown', escClose);
    }
    function escClose(e){ if (e.key === 'Escape') closeAgenda(); }

    async function carregarAgenda() {
      agendaBody.innerHTML = '<div class="modal-loading"><div class="spinner"></div>Carregando…</div>';
      try {
        const url  = `${AGENDA_API_URL}?action=agendaJson&t=${Date.now()}`;
        const resp = await fetch(url, { method: 'GET' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json(); // { days: [{date, events:[{start,end,summary,color,type}]}] }

        const days = (data && data.days) ? data.days : [];
        if (!days.length) {
          agendaBody.textContent = "Sem eventos nos próximos 60 dias.";
          return;
        }

        // Colunas Servidores | Pesquisadores
        const cols = document.createElement('div');
        cols.className = 'cols';

        const colServ = document.createElement('div');
        colServ.className = 'col';
        colServ.innerHTML = '<div class="col-header">Servidores (Sala Disponível)</div><div class="col-body" id="colServBody"></div>';

        const colPesq = document.createElement('div');
        colPesq.className = 'col';
        colPesq.innerHTML = '<div class="col-header">Pesquisadores</div><div class="col-body" id="colPesqBody"></div>';

        cols.appendChild(colServ);
        cols.appendChild(colPesq);

        const servBody = colServ.querySelector('#colServBody');
        const pesqBody = colPesq.querySelector('#colPesqBody');

        let servTemAlgo = false;
        let pesqTemAlgo = false;

        days.forEach(d => {
          const [Y,M,D] = d.date.split('-');
          const brDate = `${D}/${M}/${Y}`;

          const evServ = d.events.filter(ev => ev.type === 'servidor');
          const evPesq = d.events.filter(ev => ev.type === 'pesquisador');

          if (evServ.length) {
            servTemAlgo = true;
            const diaBox = document.createElement('div');
            diaBox.className = 'dia';

            const titulo = document.createElement('div');
            titulo.className = 'dia-titulo';
            titulo.textContent = brDate;
            diaBox.appendChild(titulo);

            evServ.forEach(ev => {
              const box = document.createElement('div');
              box.className = 'ev';
              box.style.borderLeftColor = ev.color || '#9e9e9e';

              const hora = document.createElement('span');
              hora.className = 'hora';
              hora.textContent = `${ev.start}–${ev.end} `;
              box.appendChild(hora);

              const sum = document.createElement('span');
              sum.textContent = ev.summary;
              box.appendChild(sum);

              diaBox.appendChild(box);
            });

            servBody.appendChild(diaBox);
          }

          if (evPesq.length) {
            pesqTemAlgo = true;
            const diaBox = document.createElement('div');
            diaBox.className = 'dia';

            const titulo = document.createElement('div');
            titulo.className = 'dia-titulo';
            titulo.textContent = brDate;
            diaBox.appendChild(titulo);

            evPesq.forEach(ev => {
              const box = document.createElement('div');
              box.className = 'ev';
              box.style.borderLeftColor = ev.color || '#1a73e8';

              const hora = document.createElement('span');
              hora.className = 'hora';
              hora.textContent = `${ev.start}–${ev.end} `;
              box.appendChild(hora);

              const sum = document.createElement('span');
              sum.textContent = ev.summary;
              box.appendChild(sum);

              diaBox.appendChild(box);
            });

            pesqBody.appendChild(diaBox);
          }
        });

        if (!servTemAlgo) {
          servBody.innerHTML = '<div class="col-empty">Sem eventos de Servidores.</div>';
        }
        if (!pesqTemAlgo) {
          pesqBody.innerHTML = '<div class="col-empty">Sem eventos de Pesquisadores.</div>';
        }

        agendaBody.innerHTML = '';
        agendaBody.appendChild(cols);

      } catch (err) {
        agendaBody.textContent = "Erro ao carregar a agenda: " + err.message;
      }
    }

    function initAgenda(e) {
      if (e) e.preventDefault();
      openAgenda();
      carregarAgenda(); // carrega ao abrir
    }
    document.getElementById('btnRefreshAgenda').addEventListener('click', carregarAgenda);

    // Expor funções para o HTML
    window.initAgenda = initAgenda;
    window.closeAgenda = closeAgenda;
  </script>
</body>
</html>



